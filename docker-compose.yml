version: "3.9"

services:
#  ilias:
#    build: ./ilias
#    ports:
#      - 8082:80
  traefik:
    restart: on-failure
    image: traefik:2.5.7
    ports: # if your system has already apache running on 80/443 choose different ports and adjust traefik.toml
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./traefik:/etc/traefik
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs:/etc/certs # copy certs of your host to ./certs before!
  websocket-api:
    image: viplab/websocket-api:latest
    environment:
      - JWKS_FILE=/config/jwks.json
      - amqp-host=activemq
    volumes:
      - ./jwks.json:/config/jwks.json:ro
    depends_on:
      - activemq
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.websocket-api.entrypoints=websecure"
      - "traefik.http.routers.websocket-api.tls=true"
      - "traefik.http.routers.websocket-api.rule=Host(`${HOST}`) && Path(`/computations`)"
  activemq:
    image: viplab/artemis:2.23.0-r0
    environment:
      ARTEMIS_USERNAME: user
      ARTEMIS_PASSWORD: password
  standalone-frontend:
    image: viplab/standalone-frontend:latest
    volumes:
      - ./jwks.private.json:/jwks.private.json:ro
      - ./examples:/input:ro
    environment:
      - WSAPI=wss://localhost/computations
    profiles: ["standalone"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.standalone-frontend.entrypoints=websecure"
      - "traefik.http.routers.standalone-frontend.tls=true"
      - "traefik.http.routers.standalone-frontend.rule=Host(`${HOST}`)"
  darus-connector:
    image: viplab/dv-viplab-connector:latest
    volumes:
      - ./jwks.private.json:/jwks.private.json:ro
    environment:
      - WSAPI=wss://localhost/computations
      - FLASK_SECRET
      - LOGIN_MOD_JWT_KEY
      - LOGIN_MOD_URL=https://demodarus.izus.uni-stuttgart.de/__dataverse_tools__/viplab_login/login
    profiles: ["darus"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.darus-connector.entrypoints=websecure"
      - "traefik.http.routers.darus-connector.tls=true"
      - "traefik.http.routers.darus-connector.rule=Host(`${HOST}`)"
  backend:
    image: viplab/backend:latest
    environment:
      - AMQPServer=activemq
      - endpoint_url
      - access_key
      - secret_key
      - rewrite_endpoint_url
    depends_on:
      - activemq
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  s3:
    image: scireum/s3-ninja:latest
    profiles: ["s3"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.s3.entrypoints=websecure"
      - "traefik.http.routers.s3.tls=true"
      - "traefik.http.routers.s3.rule=Host(`${HOST}`) && (PathPrefix(`/test-bucket`) || PathPrefix(`/ui`)  || PathPrefix(`/assets`))"

  dummy-backend:
    image: viplab/dummy-backend:latest
    environment:
      - amqp-host=activemq
      - viplab.responses=
    profiles: ["dummy"]
